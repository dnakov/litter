name: Android Play Closed Testing

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Play track to publish to"
        required: true
        default: "alpha"
      tester_google_group:
        description: "Optional Google Group email for tester access"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  publish-play:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android platforms
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.10.2"

      - name: Decode upload keystore
        env:
          ANDROID_UPLOAD_KEYSTORE_B64: ${{ secrets.ANDROID_UPLOAD_KEYSTORE_B64 }}
        run: |
          if [ -z "${ANDROID_UPLOAD_KEYSTORE_B64:-}" ]; then
            echo "Missing secret ANDROID_UPLOAD_KEYSTORE_B64"
            exit 1
          fi
          echo "$ANDROID_UPLOAD_KEYSTORE_B64" | base64 --decode > "$RUNNER_TEMP/litter-upload.jks"

      - name: Write Play service account JSON
        env:
          LITTER_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.LITTER_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "${LITTER_PLAY_SERVICE_ACCOUNT_JSON:-}" ]; then
            echo "Missing secret LITTER_PLAY_SERVICE_ACCOUNT_JSON"
            exit 1
          fi
          printf '%s' "$LITTER_PLAY_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/litter-play-service-account.json"

      - name: Build signed onDevice release AAB
        env:
          LITTER_UPLOAD_STORE_FILE: ${{ runner.temp }}/litter-upload.jks
          LITTER_UPLOAD_STORE_PASSWORD: ${{ secrets.LITTER_UPLOAD_STORE_PASSWORD }}
          LITTER_UPLOAD_KEY_ALIAS: ${{ secrets.LITTER_UPLOAD_KEY_ALIAS }}
          LITTER_UPLOAD_KEY_PASSWORD: ${{ secrets.LITTER_UPLOAD_KEY_PASSWORD }}
        run: gradle -p apps/android :app:bundleOnDeviceRelease

      - name: Upload AAB to Play track
        env:
          PLAY_SERVICE_ACCOUNT_JSON_PATH: ${{ runner.temp }}/litter-play-service-account.json
          PLAY_TRACK: ${{ github.event.inputs.track }}
          TESTER_GOOGLE_GROUP: ${{ github.event.inputs.tester_google_group }}
          AAB_PATH: apps/android/app/build/outputs/bundle/onDeviceRelease/app-onDevice-release.aab
          PACKAGE_NAME: com.sigkitten.litter.android
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install google-api-python-client google-auth google-auth-httplib2
          python3 - <<'PY'
          import json
          import os
          import sys

          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.errors import HttpError

          package_name = os.environ["PACKAGE_NAME"]
          track = os.environ.get("PLAY_TRACK", "alpha").strip() or "alpha"
          tester_group = os.environ.get("TESTER_GOOGLE_GROUP", "").strip()
          aab_path = os.environ["AAB_PATH"]
          creds_path = os.environ["PLAY_SERVICE_ACCOUNT_JSON_PATH"]

          if not os.path.exists(aab_path):
              print(f"AAB not found: {aab_path}", file=sys.stderr)
              sys.exit(1)

          creds = service_account.Credentials.from_service_account_file(
              creds_path,
              scopes=["https://www.googleapis.com/auth/androidpublisher"],
          )
          service = build("androidpublisher", "v3", credentials=creds, cache_discovery=False)

          edit = service.edits().insert(packageName=package_name, body={}).execute()
          edit_id = edit["id"]
          print(f"Created edit: {edit_id}")

          try:
              bundle = service.edits().bundles().upload(
                  packageName=package_name,
                  editId=edit_id,
                  media_body=aab_path,
              ).execute()
              version_code = str(bundle["versionCode"])
              print(f"Uploaded bundle versionCode={version_code}")

              release_notes = [{"language": "en-US", "text": "Automated closed-testing build upload."}]
              release_name = f"{version_code}"

              internal_body = {
                  "track": "internal",
                  "releases": [{
                      "name": release_name,
                      "status": "draft",
                      "versionCodes": [version_code],
                      "releaseNotes": release_notes,
                  }],
              }
              service.edits().tracks().update(
                  packageName=package_name,
                  editId=edit_id,
                  track="internal",
                  body=internal_body,
              ).execute()
              print("Updated internal track.")

              if track != "internal":
                  target_body = {
                      "track": track,
                      "releases": [{
                          "name": release_name,
                          "status": "draft",
                          "versionCodes": [version_code],
                          "releaseNotes": release_notes,
                      }],
                  }
                  service.edits().tracks().update(
                      packageName=package_name,
                      editId=edit_id,
                      track=track,
                      body=target_body,
                  ).execute()
                  print(f"Updated {track} track.")

                  if tester_group:
                      service.edits().testers().update(
                          packageName=package_name,
                          editId=edit_id,
                          track=track,
                          body={"googleGroups": [tester_group]},
                      ).execute()
                      print(f"Assigned tester group to {track}: {tester_group}")

              commit = service.edits().commit(packageName=package_name, editId=edit_id).execute()
              print(f"Committed edit: {commit.get('id')}")
          except HttpError as error:
              print("Play API error:", error, file=sys.stderr)
              try:
                  print(error.content.decode(), file=sys.stderr)
              except Exception:
                  pass
              try:
                  service.edits().delete(packageName=package_name, editId=edit_id).execute()
              except Exception:
                  pass
              raise
          PY

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-onDevice-release-aab
          path: apps/android/app/build/outputs/bundle/onDeviceRelease/app-onDevice-release.aab
